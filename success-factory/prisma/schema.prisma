// Prisma schema for Success Factory
// Uses Neon Postgres

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Health Score History - Track health over time for trend analysis
// ============================================================================

model HealthScoreSnapshot {
  id            String   @id @default(cuid())
  companyId     String   // HubSpot company ID
  companyName   String
  healthScore   String   // green, yellow, red, unknown
  mrr           Float?
  totalTrips    Int?
  daysSinceLastLogin Int?
  riskSignals   String[] // Array of risk signal strings
  positiveSignals String[] // Array of positive signal strings
  createdAt     DateTime @default(now())

  @@index([companyId])
  @@index([createdAt])
  @@index([companyId, createdAt])
}

// ============================================================================
// Health Change Log - Track when health scores change (for alerts/digests)
// ============================================================================

model HealthChangeLog {
  id                 String   @id @default(cuid())
  companyId          String   // Reference to HubSpotCompany.id
  company            HubSpotCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  previousScore      String?  // green, yellow, red, unknown (null if first sync)
  newScore           String   // green, yellow, red, unknown
  previousNumericScore Int?
  newNumericScore    Int?
  riskSignals        String[] // Risk signals at time of change
  trigger            String?  // What caused the change (sync, manual, etc.)
  changedAt          DateTime @default(now())

  @@index([companyId])
  @@index([changedAt])
  @@index([newScore])
}

// ============================================================================
// Playbooks - Automated workflows triggered by conditions
// ============================================================================

model Playbook {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String   // e.g., "health_drops_to_red", "renewal_30_days", "inactive_60_days"
  isActive    Boolean  @default(true)
  actions     Json     // Array of action definitions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks       Task[]
}

// ============================================================================
// Tasks - CSM action items (manual or from playbooks)
// ============================================================================

model Task {
  id          String    @id @default(cuid())
  companyId   String    // HubSpot company ID
  companyName String
  title       String
  description String?
  priority    String    @default("medium") // low, medium, high, urgent
  status      String    @default("pending") // pending, in_progress, completed, cancelled
  dueDate     DateTime?
  completedAt DateTime?
  ownerId     String?   // HubSpot owner ID (CSM)
  ownerEmail  String?
  playbook    Playbook? @relation(fields: [playbookId], references: [id])
  playbookId  String?
  metadata    Json?     // Additional context
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Single-column indexes
  @@index([companyId])
  @@index([ownerId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])

  // Composite indexes for common query patterns
  @@index([status, dueDate])            // Task list filtering
  @@index([companyId, status])          // Company task lookup
  @@index([ownerEmail, status])         // CSM task lookup
  @@index([status, priority])           // Priority filtering
}

// ============================================================================
// Alert Log - Track sent notifications
// ============================================================================

model AlertLog {
  id          String   @id @default(cuid())
  type        String   // at_risk, health_change, renewal_upcoming, etc.
  companyId   String?
  companyName String?
  channel     String   // slack, email
  payload     Json     // Full alert payload
  success     Boolean
  error       String?
  createdAt   DateTime @default(now())

  @@index([companyId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// User Preferences - Settings for CSMs
// ============================================================================

model UserPreference {
  id              String   @id @default(cuid())
  neonUserId      String   @unique // Neon Auth user ID
  hubspotOwnerId  String?  // HubSpot owner ID (optional, for linking)
  email           String
  name            String?
  avatarUrl       String?  // Profile picture URL (Vercel Blob)
  slackUserId     String?  // For direct Slack notifications
  alertPreferences Json?   // What alerts they want
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
}

// ============================================================================
// Global Settings - Site-wide configuration (singleton)
// ============================================================================

model GlobalSettings {
  id          String   @id @default("default") // Always "default" for singleton
  notifications Json   // NotificationPreferences object
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================================
// Customer Journey - Track lifecycle stages for accounts
// ============================================================================

model CustomerJourney {
  id          String   @id @default(cuid())
  companyId   String   @unique // HubSpot company ID
  companyName String
  stage       String   // onboarding, adoption, growth, maturity, renewal, at_risk, churned
  previousStage String?
  stageChangedAt DateTime @default(now())
  notes       String?
  metadata    Json?    // Additional context like reason for stage change
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  history     JourneyStageHistory[]

  @@index([companyId])
  @@index([stage])
}

model JourneyStageHistory {
  id          String   @id @default(cuid())
  journeyId   String
  journey     CustomerJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  fromStage   String?
  toStage     String
  changedBy   String?  // Email or system
  reason      String?
  createdAt   DateTime @default(now())

  @@index([journeyId])
  @@index([createdAt])
}

// ============================================================================
// NPS Surveys - Track Net Promoter Score responses
// ============================================================================

model NPSSurvey {
  id           String   @id @default(cuid())
  companyId    String   // HubSpot company ID
  companyName  String
  contactEmail String   // Email of person who received survey
  contactName  String?
  token        String   @unique // Unique token for response URL
  triggerType  String   @default("manual") // day_30, day_90, post_support, pre_renewal, quarterly, manual
  sentAt       DateTime @default(now())
  respondedAt  DateTime?
  score        Int?     // 0-10 NPS score
  comment      String?  // Optional follow-up comment
  category     String?  // promoter (9-10), passive (7-8), detractor (0-6)
  followedUpAt DateTime? // When CSM followed up on response
  followUpNotes String?  // Notes from follow-up

  @@index([companyId])
  @@index([token])
  @@index([sentAt])
  @@index([category])
  @@index([triggerType])
}

// ============================================================================
// AI Predictions - Claude-powered churn risk analysis
// ============================================================================

model AIPrediction {
  id            String   @id @default(cuid())
  companyId     String   // HubSpot company ID
  companyName   String
  riskScore     Float    // 0-100 churn probability
  riskLevel     String   // low, medium, high, critical
  reasoning     String   // Claude's explanation
  signals       Json     // Input signals used for prediction
  recommendations Json?  // Suggested actions
  createdAt     DateTime @default(now())

  @@index([companyId])
  @@index([riskLevel])
  @@index([createdAt])
}

// ============================================================================
// HubSpot Company - Synced customer data (refreshed 1-2x daily)
// ============================================================================

model HubSpotCompany {
  id                  String   @id @default(cuid())
  hubspotId           String   @unique // HubSpot company ID
  name                String
  domain              String?

  // Subscription & Revenue
  mrr                 Float?   // Monthly recurring revenue
  subscriptionStatus  String?  // active, churned, trial, etc.
  plan                String?  // Plan name/tier (Lago Plan Name)
  planCode            String?  // Lago Plan Code (vip-monthly, pro-annual, etc.)
  customerSegment     String?  // enterprise, mid-market, smb, free (derived from plan)
  contractEndDate     DateTime? // Renewal date

  // Usage & Engagement
  totalTrips          Int?     // Usage metric (R Total Reservations Count)
  tripsLast30Days     Int?     // R Last 30 Days Reservations Count
  lastLoginAt         DateTime? // Last activity
  lastTripCreatedAt   DateTime? // R Last Trip Created At
  daysSinceLastLogin  Int?     // Days Since Last Created Trip
  daysSinceLastAssignment Int? // Da Days Since Last Assignment (CSM activity)
  engagementStatus    String?  // Da Engagement Status

  // Fleet & Product Usage (from Moovs Product data)
  vehiclesTotal       Int?     // P Vehicles Total
  membersCount        Int?     // P Total Members
  driversCount        Int?     // P Drivers Count
  setupScore          Int?     // P Setup Score (0-100 onboarding completion)
  subscriptionLifetimeDays Int? // Lago Lifetime Days

  // Deal Info (from HubSpot Deals)
  dealStage           String?  // Hs D Stage Name
  dealPipeline        String?  // Hs D Pipeline Segment
  dealCloseDate       DateTime? // Hs D Close Date
  dealAmount          Float?   // Hs D Closed Amount

  // Location
  latitude            String?
  longitude           String?

  // Payment Health (from Stripe via Metabase)
  paymentSuccessRate  Float?   // 0-100% payment success rate
  failedPaymentCount  Int?     // Failed payments in last 90 days
  disputeCount        Int?     // Active/recent disputes
  avgRiskScore        Float?   // Average Stripe risk score (0-100)
  paymentHealth       String?  // good, at_risk, critical
  totalChargeVolume   Float?   // Total $ charged through Stripe

  // Support Health (from Notion tickets)
  openTicketCount     Int?     // Open support tickets
  ticketAgeDays       Int?     // Oldest open ticket age

  // CSM Assignment
  ownerId             String?  // HubSpot owner ID
  ownerName           String?
  ownerEmail          String?

  // Computed Health
  healthScore         String?  // green, yellow, red, unknown
  numericHealthScore  Int?     // 0-100 weighted score
  riskSignals         String[] // Array of risk signal strings
  positiveSignals     String[] // Array of positive signal strings

  // Health Score Components (0-100 each)
  paymentScore        Int?     // Payment health dimension (40% weight)
  engagementScore     Int?     // Engagement dimension (25% weight)
  supportScore        Int?     // Support health dimension (20% weight)
  growthScore         Int?     // Growth signals dimension (15% weight)

  // Contacts (primary)
  primaryContactName  String?
  primaryContactEmail String?

  // Metadata
  industry            String?
  city                String?
  state               String?
  country             String?
  employeeCount       Int?
  operatorId          String?  // Moovs operator ID (for cross-referencing)
  stripeAccountId     String?  // Stripe Connect account ID

  // Data source tracking
  hasHubSpotRecord    Boolean  @default(true)  // False if synced from Metabase only
  hubspotRecordId     String?  // Actual HubSpot ID (null if no HubSpot record)

  // HubSpot timestamps
  hubspotCreatedAt    DateTime?
  hubspotUpdatedAt    DateTime?

  // Sync tracking
  lastSyncedAt        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  healthChanges       HealthChangeLog[]
  campaignEnrollments CampaignEnrollment[]

  // Single-column indexes
  @@index([hubspotId])
  @@index([ownerId])
  @@index([healthScore])
  @@index([numericHealthScore])
  @@index([subscriptionStatus])
  @@index([customerSegment])
  @@index([contractEndDate])
  @@index([lastSyncedAt])
  @@index([operatorId])
  @@index([mrr])
  @@index([createdAt])

  // Composite indexes for common query patterns
  @@index([healthScore, mrr])              // Dashboard filtering
  @@index([customerSegment, mrr])          // Segment analysis
  @@index([createdAt, healthScore])        // Cohort queries
  @@index([ownerId, healthScore])          // CSM portfolio filtering
  @@index([subscriptionStatus, mrr])       // Revenue analysis
}

// ============================================================================
// Sync Log - Track HubSpot sync runs
// ============================================================================

model SyncLog {
  id            String   @id @default(cuid())
  type          String   // companies, contacts, deals
  status        String   // running, completed, failed
  recordsFound  Int?
  recordsSynced Int?
  recordsFailed Int?
  error         String?
  startedAt     DateTime @default(now())
  completedAt   DateTime?

  @@index([type])
  @@index([startedAt])
}

// ============================================================================
// Churn Documentation - Structured capture of churn reasons for pattern learning
// ============================================================================

model ChurnRecord {
  id              String   @id @default(cuid())
  companyId       String   // HubSpot company ID
  companyName     String
  domain          String?

  // When did they churn
  churnDate       DateTime @default(now())
  customerSince   DateTime? // To calculate lifetime

  // Financial impact
  lostMrr         Float?
  lifetimeValue   Float?

  // Primary reason (categorized)
  primaryReason   String   // price, product_fit, support, competitor, business_closed, budget, other
  secondaryReason String?

  // Detailed capture
  reasonDetails   String?  // Free-form explanation
  competitorName  String?  // If lost to competitor
  featureGaps     String[] // Features they needed but didn't have

  // Context at time of churn
  healthScoreAtChurn String? // green, yellow, red
  daysSinceLastLogin Int?
  totalTrips      Int?
  lastContactDate DateTime?

  // Exit interview
  exitInterviewDone Boolean @default(false)
  exitInterviewNotes String?
  willingToReturn   Boolean?
  returnConditions  String? // What would bring them back

  // Who documented this
  documentedBy    String?  // CSM email
  documentedAt    DateTime @default(now())

  // Follow-up tracking
  winBackAttempted Boolean @default(false)
  winBackDate     DateTime?
  winBackSuccessful Boolean?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@index([primaryReason])
  @@index([churnDate])
  @@index([lostMrr])
}

// ============================================================================
// Churn Pattern - AI-generated insights from churn data
// ============================================================================

model ChurnPattern {
  id              String   @id @default(cuid())
  patternType     String   // reason_trend, segment_risk, feature_gap, seasonal
  title           String
  description     String
  affectedSegment String?  // e.g., "SMB", "Enterprise", "Free plan"
  frequency       Int      // How many churns match this pattern
  mrrImpact       Float?   // Total MRR lost to this pattern
  recommendations String[] // AI-suggested actions
  confidence      Float?   // 0-1 confidence score
  dataRange       String?  // e.g., "Last 90 days"
  generatedAt     DateTime @default(now())

  @@index([patternType])
  @@index([affectedSegment])
}

// ============================================================================
// Onboarding Milestones - Track time-to-value for new customers
// ============================================================================

model OnboardingMilestone {
  id          String    @id @default(cuid())
  companyId   String    // HubSpot company ID
  companyName String
  milestone   String    // first_login, profile_complete, first_vehicle, first_driver, first_trip, first_payment, portal_setup, first_recurring, api_integration
  targetDays  Int       // Days from signup to complete this milestone
  completedAt DateTime?
  isOverdue   Boolean   @default(false)
  isRequired  Boolean   @default(true) // Required for segment
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([companyId, milestone])
  @@index([companyId])
  @@index([isOverdue])
  @@index([milestone])
}

// ============================================================================
// Activity Events - Unified timeline of all customer interactions
// ============================================================================

model ActivityEvent {
  id          String   @id @default(cuid())
  companyId   String   // HubSpot company ID
  source      String   // hubspot, stripe, support, platform, nps, journey, task
  eventType   String   // email_sent, payment_failed, ticket_opened, health_changed, etc.
  title       String   // Human-readable title
  description String?  // Details
  metadata    Json?    // Source-specific data
  importance  String   @default("normal") // low, normal, high, critical
  occurredAt  DateTime
  createdAt   DateTime @default(now())

  @@index([companyId, occurredAt])
  @@index([companyId])
  @@index([source])
  @@index([eventType])
  @@index([importance])
}

// ============================================================================
// Stakeholders - Key contacts and champions per account
// ============================================================================

model Stakeholder {
  id            String    @id @default(cuid())
  companyId     String    // HubSpot company ID
  hubspotContactId String? // HubSpot contact ID if synced
  name          String
  email         String?
  phone         String?
  title         String?
  role          String    // champion, decision_maker, user, influencer, detractor, executive_sponsor
  sentiment     String    @default("neutral") // positive, neutral, negative, unknown
  influence     String    @default("medium") // high, medium, low
  engagement    String    @default("active") // active, passive, disengaged
  lastContactAt DateTime?
  notes         String?
  isActive      Boolean   @default(true)
  leftCompanyAt DateTime? // Track if they left
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([companyId, email])
  @@index([companyId])
  @@index([role])
  @@index([sentiment])
  @@index([isActive])
}

// ============================================================================
// Expansion Opportunities - Track upsell/cross-sell potential
// ============================================================================

model ExpansionOpportunity {
  id              String    @id @default(cuid())
  companyId       String    // HubSpot company ID
  companyName     String
  type            String    // upsell, cross_sell, add_on, upgrade
  status          String    @default("identified") // identified, qualified, in_progress, won, lost, deferred
  source          String    // usage_growth, feature_request, plan_limit, csm_identified, ai_detected
  title           String    // Brief description
  description     String?   // Full details
  currentValue    Float?    // Current MRR
  potentialValue  Float?    // Potential additional MRR
  confidence      String    @default("medium") // high, medium, low
  signals         Json?     // Evidence that triggered this opportunity
  nextSteps       String?   // Recommended actions
  ownerId         String?   // CSM who owns this opportunity
  targetCloseDate DateTime?
  closedAt        DateTime?
  closedValue     Float?    // Actual value if won
  lostReason      String?   // If lost, why
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([type])
  @@index([confidence])
  @@index([createdAt])
}

// ============================================================================
// Cohort - Track customer cohorts for analysis
// ============================================================================

model CustomerCohort {
  id              String   @id @default(cuid())
  companyId       String   @unique // HubSpot company ID
  signupMonth     String   // YYYY-MM format
  signupQuarter   String   // YYYY-Q# format
  acquisitionSource String? // Source of acquisition
  initialPlan     String?  // Plan at signup
  initialMrr      Float?   // MRR at signup
  initialSegment  String?  // Segment at signup
  firstValueDate  DateTime? // When they first saw value (first trip completed)
  timeToValue     Int?     // Days from signup to first value
  isActive        Boolean  @default(true)
  churnedAt       DateTime?
  churnMonth      String?  // YYYY-MM if churned
  lifetimeMonths  Int?     // Months as customer
  totalRevenue    Float?   // Total revenue generated
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([signupMonth])
  @@index([signupQuarter])
  @@index([initialSegment])
  @@index([isActive])
}

// ============================================================================
// Campaign - Multi-step automated sequences
// ============================================================================

model Campaign {
  id                String   @id @default(cuid())
  name              String
  description       String?
  triggerType       String   @default("manual") // manual, health_change, renewal_upcoming, segment_change
  triggerConditions Json?    // Conditions for auto-enrollment
  status            String   @default("draft") // draft, active, paused, archived
  ownerEmail        String?
  ownerName         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  steps             CampaignStep[]
  enrollments       CampaignEnrollment[]

  @@index([status])
  @@index([triggerType])
  @@index([ownerEmail])
}

model CampaignStep {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  stepOrder   Int
  type        String   // email, task, wait, condition, webhook
  name        String
  config      Json     // Step-specific configuration
  delayDays   Int      @default(0)
  delayHours  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([campaignId])
  @@index([stepOrder])
}

model CampaignEnrollment {
  id               String    @id @default(cuid())
  campaignId       String
  campaign         Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  companyId        String    // FK to HubSpotCompany.id
  company          HubSpotCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  status           String    @default("active") // active, paused, completed, exited
  currentStepId    String?   // Current step ID
  currentStepOrder Int       @default(1)
  nextStepDue      DateTime?
  enrolledAt       DateTime  @default(now())
  completedAt      DateTime?
  exitedAt         DateTime?
  exitReason       String?
  metadata         Json?

  @@unique([campaignId, companyId])
  @@index([campaignId])
  @@index([companyId])
  @@index([status])
  @@index([nextStepDue])
}
