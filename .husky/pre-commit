#!/bin/sh

cd success-factory

# Run lint-staged (ESLint + Prettier on staged files only)
echo "ğŸ” Running lint-staged..."
npx lint-staged || {
  echo "âŒ Lint-staged failed. Please fix errors before committing."
  exit 1
}

# Run TypeScript type check
echo "ğŸ“˜ Running TypeScript check..."
npm run typecheck --silent || {
  echo "âŒ TypeScript check failed. Please fix type errors before committing."
  exit 1
}

# Run secrets detection on staged files
echo "ğŸ” Checking for secrets..."
# Strip 'success-factory/' prefix since we're already in that directory and run secretlint
# Only check files that are in the success-factory directory
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep '^success-factory/' | sed 's|^success-factory/||' || true)
if [ -n "$staged_files" ]; then
  echo "$staged_files" | xargs ./node_modules/.bin/secretlint 2>/dev/null
  secretlint_exit=$?
  if [ $secretlint_exit -eq 1 ]; then
    echo "âŒ Secrets detected! Please remove sensitive data before committing."
    exit 1
  fi
fi

# Run color audit
echo "ğŸ¨ Running color audit..."
node scripts/audit-colors.cjs || {
  echo "âŒ Color audit failed. Please use semantic color tokens."
  exit 1
}

echo "âœ… Pre-commit checks passed!"
exit 0
