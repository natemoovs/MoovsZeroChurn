#!/bin/sh

cd success-factory

# Run lint-staged (ESLint + Prettier on staged files only)
echo "ğŸ” Running lint-staged..."
npx lint-staged || {
  echo "âŒ Lint-staged failed. Please fix errors before committing."
  exit 1
}

# Run TypeScript type check
echo "ğŸ“˜ Running TypeScript check..."
npm run typecheck --silent || {
  echo "âŒ TypeScript check failed. Please fix type errors before committing."
  exit 1
}

# Run secrets detection on staged files
echo "ğŸ” Checking for secrets..."
# Get list of staged files that can be checked for secrets
# Note: secretlint has issues with paths containing brackets, so we use glob patterns
staged_ts_files=$(git diff --cached --name-only --diff-filter=ACM -- '*.ts' '*.tsx' '*.js' '*.json' | grep '^success-factory/' || true)
if [ -n "$staged_ts_files" ]; then
  # Run secretlint on all staged files using glob pattern
  # Exit code 1 = secrets found, 0 = no secrets, other = error (ignore)
  ./node_modules/.bin/secretlint '**/*.{ts,tsx,js,json}' 2>/dev/null
  result=$?
  if [ $result -eq 1 ]; then
    echo "âŒ Secrets detected! Please remove sensitive data before committing."
    exit 1
  fi
fi

# Run color audit
echo "ğŸ¨ Running color audit..."
node scripts/audit-colors.cjs || {
  echo "âŒ Color audit failed. Please use semantic color tokens."
  exit 1
}

echo "âœ… Pre-commit checks passed!"
exit 0
