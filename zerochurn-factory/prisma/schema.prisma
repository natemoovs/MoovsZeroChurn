// Prisma schema for ZeroChurn Factory
// Uses Neon Postgres

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Health Score History - Track health over time for trend analysis
// ============================================================================

model HealthScoreSnapshot {
  id            String   @id @default(cuid())
  companyId     String   // HubSpot company ID
  companyName   String
  healthScore   String   // green, yellow, red, unknown
  mrr           Float?
  totalTrips    Int?
  daysSinceLastLogin Int?
  riskSignals   String[] // Array of risk signal strings
  positiveSignals String[] // Array of positive signal strings
  createdAt     DateTime @default(now())

  @@index([companyId])
  @@index([createdAt])
  @@index([companyId, createdAt])
}

// ============================================================================
// Playbooks - Automated workflows triggered by conditions
// ============================================================================

model Playbook {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String   // e.g., "health_drops_to_red", "renewal_30_days", "inactive_60_days"
  isActive    Boolean  @default(true)
  actions     Json     // Array of action definitions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks       Task[]
}

// ============================================================================
// Tasks - CSM action items (manual or from playbooks)
// ============================================================================

model Task {
  id          String    @id @default(cuid())
  companyId   String    // HubSpot company ID
  companyName String
  title       String
  description String?
  priority    String    @default("medium") // low, medium, high, urgent
  status      String    @default("pending") // pending, in_progress, completed, cancelled
  dueDate     DateTime?
  completedAt DateTime?
  ownerId     String?   // HubSpot owner ID (CSM)
  ownerEmail  String?
  playbook    Playbook? @relation(fields: [playbookId], references: [id])
  playbookId  String?
  metadata    Json?     // Additional context
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyId])
  @@index([ownerId])
  @@index([status])
  @@index([dueDate])
}

// ============================================================================
// Alert Log - Track sent notifications
// ============================================================================

model AlertLog {
  id          String   @id @default(cuid())
  type        String   // at_risk, health_change, renewal_upcoming, etc.
  companyId   String?
  companyName String?
  channel     String   // slack, email
  payload     Json     // Full alert payload
  success     Boolean
  error       String?
  createdAt   DateTime @default(now())

  @@index([companyId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// User Preferences - Settings for CSMs
// ============================================================================

model UserPreference {
  id              String   @id @default(cuid())
  neonUserId      String   @unique // Neon Auth user ID
  hubspotOwnerId  String?  // HubSpot owner ID (optional, for linking)
  email           String
  name            String?
  slackUserId     String?  // For direct Slack notifications
  alertPreferences Json?   // What alerts they want
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
}

// ============================================================================
// Global Settings - Site-wide configuration (singleton)
// ============================================================================

model GlobalSettings {
  id          String   @id @default("default") // Always "default" for singleton
  notifications Json   // NotificationPreferences object
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================================
// Customer Journey - Track lifecycle stages for accounts
// ============================================================================

model CustomerJourney {
  id          String   @id @default(cuid())
  companyId   String   @unique // HubSpot company ID
  companyName String
  stage       String   // onboarding, adoption, growth, maturity, renewal, at_risk, churned
  previousStage String?
  stageChangedAt DateTime @default(now())
  notes       String?
  metadata    Json?    // Additional context like reason for stage change
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  history     JourneyStageHistory[]

  @@index([companyId])
  @@index([stage])
}

model JourneyStageHistory {
  id          String   @id @default(cuid())
  journeyId   String
  journey     CustomerJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  fromStage   String?
  toStage     String
  changedBy   String?  // Email or system
  reason      String?
  createdAt   DateTime @default(now())

  @@index([journeyId])
  @@index([createdAt])
}

// ============================================================================
// NPS Surveys - Track Net Promoter Score responses
// ============================================================================

model NPSSurvey {
  id          String   @id @default(cuid())
  companyId   String   // HubSpot company ID
  companyName String
  contactEmail String  // Email of person who received survey
  contactName  String?
  token       String   @unique // Unique token for response URL
  sentAt      DateTime @default(now())
  respondedAt DateTime?
  score       Int?     // 0-10 NPS score
  comment     String?  // Optional follow-up comment
  category    String?  // promoter (9-10), passive (7-8), detractor (0-6)

  @@index([companyId])
  @@index([token])
  @@index([sentAt])
  @@index([category])
}

// ============================================================================
// AI Predictions - Claude-powered churn risk analysis
// ============================================================================

model AIPrediction {
  id            String   @id @default(cuid())
  companyId     String   // HubSpot company ID
  companyName   String
  riskScore     Float    // 0-100 churn probability
  riskLevel     String   // low, medium, high, critical
  reasoning     String   // Claude's explanation
  signals       Json     // Input signals used for prediction
  recommendations Json?  // Suggested actions
  createdAt     DateTime @default(now())

  @@index([companyId])
  @@index([riskLevel])
  @@index([createdAt])
}

// ============================================================================
// HubSpot Company - Synced customer data (refreshed 1-2x daily)
// ============================================================================

model HubSpotCompany {
  id                  String   @id @default(cuid())
  hubspotId           String   @unique // HubSpot company ID
  name                String
  domain              String?

  // Subscription & Revenue
  mrr                 Float?   // Monthly recurring revenue
  subscriptionStatus  String?  // active, churned, trial, etc.
  plan                String?  // Plan name/tier
  contractEndDate     DateTime? // Renewal date

  // Usage & Engagement
  totalTrips          Int?     // Usage metric
  lastLoginAt         DateTime? // Last activity
  daysSinceLastLogin  Int?     // Computed for convenience

  // CSM Assignment
  ownerId             String?  // HubSpot owner ID
  ownerName           String?
  ownerEmail          String?

  // Computed Health
  healthScore         String?  // green, yellow, red, unknown
  riskSignals         String[] // Array of risk signal strings
  positiveSignals     String[] // Array of positive signal strings

  // Contacts (primary)
  primaryContactName  String?
  primaryContactEmail String?

  // Metadata
  industry            String?
  city                String?
  state               String?
  country             String?
  employeeCount       Int?

  // HubSpot timestamps
  hubspotCreatedAt    DateTime?
  hubspotUpdatedAt    DateTime?

  // Sync tracking
  lastSyncedAt        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([hubspotId])
  @@index([ownerId])
  @@index([healthScore])
  @@index([subscriptionStatus])
  @@index([contractEndDate])
  @@index([lastSyncedAt])
}

// ============================================================================
// Sync Log - Track HubSpot sync runs
// ============================================================================

model SyncLog {
  id            String   @id @default(cuid())
  type          String   // companies, contacts, deals
  status        String   // running, completed, failed
  recordsFound  Int?
  recordsSynced Int?
  recordsFailed Int?
  error         String?
  startedAt     DateTime @default(now())
  completedAt   DateTime?

  @@index([type])
  @@index([startedAt])
}

// ============================================================================
// Churn Documentation - Structured capture of churn reasons for pattern learning
// ============================================================================

model ChurnRecord {
  id              String   @id @default(cuid())
  companyId       String   // HubSpot company ID
  companyName     String
  domain          String?

  // When did they churn
  churnDate       DateTime @default(now())
  customerSince   DateTime? // To calculate lifetime

  // Financial impact
  lostMrr         Float?
  lifetimeValue   Float?

  // Primary reason (categorized)
  primaryReason   String   // price, product_fit, support, competitor, business_closed, budget, other
  secondaryReason String?

  // Detailed capture
  reasonDetails   String?  // Free-form explanation
  competitorName  String?  // If lost to competitor
  featureGaps     String[] // Features they needed but didn't have

  // Context at time of churn
  healthScoreAtChurn String? // green, yellow, red
  daysSinceLastLogin Int?
  totalTrips      Int?
  lastContactDate DateTime?

  // Exit interview
  exitInterviewDone Boolean @default(false)
  exitInterviewNotes String?
  willingToReturn   Boolean?
  returnConditions  String? // What would bring them back

  // Who documented this
  documentedBy    String?  // CSM email
  documentedAt    DateTime @default(now())

  // Follow-up tracking
  winBackAttempted Boolean @default(false)
  winBackDate     DateTime?
  winBackSuccessful Boolean?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@index([primaryReason])
  @@index([churnDate])
  @@index([lostMrr])
}

// ============================================================================
// Churn Pattern - AI-generated insights from churn data
// ============================================================================

model ChurnPattern {
  id              String   @id @default(cuid())
  patternType     String   // reason_trend, segment_risk, feature_gap, seasonal
  title           String
  description     String
  affectedSegment String?  // e.g., "SMB", "Enterprise", "Free plan"
  frequency       Int      // How many churns match this pattern
  mrrImpact       Float?   // Total MRR lost to this pattern
  recommendations String[] // AI-suggested actions
  confidence      Float?   // 0-1 confidence score
  dataRange       String?  // e.g., "Last 90 days"
  generatedAt     DateTime @default(now())

  @@index([patternType])
  @@index([affectedSegment])
}
